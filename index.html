<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤ëŠ˜ì˜ ì‹œí™© ë¸Œë¦¬í•‘ (Free)</title>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0d0f14;
      --surface: #161b24;
      --surface2: #1e2535;
      --border: rgba(255,255,255,0.07);
      --text: #f0f2f7;
      --muted: #8b93a8;
      --up: #ff5b5b;
      --down: #4c8ef7;
      --accent: #6366f1;
      --gold: #f59e0b;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Pretendard', -apple-system, sans-serif;
      padding-bottom: 86px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .wrap { max-width: 480px; margin: 0 auto; padding: 0 16px; }

    header { padding: 28px 0 18px; }
    .header-date { font-size: 12px; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 6px; }
    .header-title { font-size: 24px; font-weight: 800; letter-spacing: -0.03em; }
    .header-title span { background: linear-gradient(135deg, #6366f1, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-sub { font-size: 13px; color: var(--muted); margin-top: 6px; line-height: 1.4; }

    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .summary-card {
      background: linear-gradient(135deg, #1a1d35, #1e2535);
      border: 1px solid rgba(99,102,241,0.25);
      border-radius: 20px;
      padding: 18px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    .summary-card::before {
      content: '';
      position: absolute;
      top: -30px; right: -30px;
      width: 100px; height: 100px;
      background: radial-gradient(circle, rgba(99,102,241,0.12), transparent 70%);
    }
    .summary-label {
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; font-weight: 800; color: #818cf8;
      letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 10px;
    }
    .ai-dot { width: 6px; height: 6px; background: #6366f1; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }
    .summary-text { font-size: 13px; line-height: 1.75; color: #c7d2fe; font-weight: 600; }
    .summary-text strong { color: #fff; font-weight: 800; }

    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .section-title {
      font-size: 12px; font-weight: 800; color: var(--muted);
      letter-spacing: 0.06em; text-transform: uppercase;
      display: flex; align-items: center; gap: 8px;
    }
    .section-title::before { content: ''; width: 3px; height: 12px; background: var(--accent); border-radius: 2px; }
    .refresh-btn {
      font-size: 11px; color: var(--muted); cursor: pointer;
      background: none; border: none; display: flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 10px; transition: background 0.15s, color 0.15s;
      font-weight: 800;
    }
    .refresh-btn:hover { background: var(--surface2); color: var(--text); }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .index-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 24px; }
    .index-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 16px; transition: all 0.2s;
    }
    .index-name { font-size: 11px; color: var(--muted); font-weight: 700; margin-bottom: 6px; }
    .index-value { font-size: 19px; font-weight: 900; letter-spacing: -0.02em; margin-bottom: 3px; }
    .index-change { font-size: 12px; font-weight: 900; display: flex; align-items: center; gap: 4px; }
    .up { color: var(--up); }
    .down { color: var(--down); }
    .neutral-c { color: var(--muted); }
    .mini-chart { margin-top: 10px; height: 30px; width: 100%; }

    .fx-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 24px; }
    .fx-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 10px; text-align: center;
    }
    .fx-label { font-size: 10px; color: var(--muted); margin-bottom: 5px; font-weight: 900; letter-spacing: 0.05em; text-transform: uppercase; }
    .fx-value { font-size: 15px; font-weight: 900; letter-spacing: -0.01em; margin-bottom: 3px; }
    .fx-change { font-size: 11px; font-weight: 900; }

    .re-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 24px; }
    .re-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px 10px; text-align: center;
    }
    .re-region { font-size: 11px; color: var(--muted); margin-bottom: 5px; font-weight: 900; }
    .re-value { font-size: 15px; font-weight: 900; letter-spacing: -0.02em; margin-bottom: 3px; }
    .re-sub { font-size: 11px; font-weight: 900; }

    .stock-list {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; overflow: hidden; margin-bottom: 24px;
    }
    .stock-item {
      display: flex; align-items: center; padding: 13px 16px;
      border-bottom: 1px solid var(--border);
    }
    .stock-item:last-child { border-bottom: none; }
    .stock-rank { font-size: 12px; color: var(--muted); font-weight: 900; width: 18px; flex-shrink: 0; }
    .stock-icon {
      width: 34px; height: 34px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 900; margin: 0 10px 0 8px; flex-shrink: 0;
    }
    .stock-info { flex: 1; }
    .stock-name { font-size: 13px; font-weight: 900; margin-bottom: 1px; }
    .stock-ticker { font-size: 11px; color: var(--muted); font-weight: 800; }
    .stock-price-wrap { text-align: right; }
    .stock-price { font-size: 14px; font-weight: 900; margin-bottom: 2px; }
    .stock-change { font-size: 11px; font-weight: 900; }

    .last-updated { text-align: center; font-size: 11px; color: var(--muted); margin-bottom: 16px; font-weight: 900; }

    .page { display: none; opacity: 0; transform: translateY(8px); transition: opacity .18s ease, transform .18s ease; }
    .page.active { display: block; opacity: 1; transform: translateY(0); }

    .page-title { display:flex; align-items:flex-end; justify-content:space-between; gap: 10px; margin: 10px 0 14px; }
    .page-h2 { font-size: 14px; font-weight: 900; letter-spacing: -0.02em; color: #e7e9f7; }
    .page-desc { font-size: 11px; font-weight: 800; color: var(--muted); margin-top: 4px; line-height: 1.5; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 16px;
      margin-bottom: 14px;
    }

    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(13,15,20,0.92); backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; padding: 10px 0 18px; z-index: 100;
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; opacity: 0.45; transition: opacity 0.2s, transform 0.2s; user-select: none; }
    .nav-item:active { transform: scale(0.98); }
    .nav-item.active { opacity: 1; }
    .nav-icon { font-size: 20px; }
    .nav-label { font-size: 10px; font-weight: 900; }
    .nav-item.active .nav-label { color: #818cf8; }

    .toast {
      position: fixed; bottom: 96px; left: 50%; transform: translateX(-50%);
      background: #1e2535; border: 1px solid rgba(255,91,91,0.4);
      color: #ffb3b3; font-size: 12px; padding: 10px 16px;
      border-radius: 12px; z-index: 999; opacity: 0;
      transition: opacity 0.3s; pointer-events: none; white-space: nowrap;
      font-weight: 900;
    }
    .toast.show { opacity: 1; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="header-date" id="todayDate"></div>
      <h1 class="header-title">ì˜¤ëŠ˜ì˜ <span>ì‹œí™© ë¸Œë¦¬í•‘</span></h1>
      <p class="header-sub" id="headerSub">ì™„ì „ ë¬´ë£Œ ëª¨ë“œ Â· Stooq ë°ì´í„° + ë¬´ë£Œ CORS í”„ë¡ì‹œ(ë¶ˆì•ˆì • ì‹œ ìë™ ëŒ€ì²´)</p>
    </header>

    <!-- PAGE: ì‹œí™© -->
    <section class="page active" id="page-market" data-page="market">
      <div class="summary-card">
        <div class="summary-label"><div class="ai-dot"></div>ë¸Œë¦¬í•‘ ìš”ì•½</div>
        <p class="summary-text" id="summaryText">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ì—ìš”...</p>
      </div>

      <div>
        <div class="section-header">
          <div class="section-title">ë¯¸êµ­ ì§€ìˆ˜ (ë¬´ë£Œ)</div>
          <button class="refresh-btn" onclick="loadMarketData()">
            <span id="refreshIcon">â†»</span> ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
        <div class="index-row" id="usIndexRow">
          <div class="index-card">
            <div class="index-name">ë‚˜ìŠ¤ë‹¥ ëŒ€ì²´(QQQ)</div>
            <div class="index-value skeleton" style="height:28px;width:120px;margin-bottom:6px"></div>
            <div class="skeleton" style="height:16px;width:140px"></div>
            <div class="mini-chart skeleton"></div>
          </div>
          <div class="index-card">
            <div class="index-name">S&P500 ëŒ€ì²´(SPY)</div>
            <div class="index-value skeleton" style="height:28px;width:120px;margin-bottom:6px"></div>
            <div class="skeleton" style="height:16px;width:140px"></div>
            <div class="mini-chart skeleton"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="section-header"><div class="section-title">í™˜ìœ¨ Â· ê¸ˆë¦¬</div></div>
        <div class="fx-row" id="fxRow">
          <div class="fx-card"><div class="fx-label">USD/KRW</div><div class="skeleton" style="height:22px;margin:4px 0"></div><div class="skeleton" style="height:14px;width:60%;margin:0 auto"></div></div>
          <div class="fx-card"><div class="fx-label">ê¸°ì¤€ê¸ˆë¦¬</div><div class="fx-value">â€”</div><div class="fx-change neutral-c">ë¬´ë£Œëª¨ë“œ(ë¯¸êµ¬í˜„)</div></div>
          <div class="fx-card"><div class="fx-label">êµ­ê³ ì±„ 3Y</div><div class="fx-value">â€”</div><div class="fx-change neutral-c">ë¬´ë£Œëª¨ë“œ(ë¯¸êµ¬í˜„)</div></div>
        </div>
      </div>

      <div class="last-updated" id="lastUpdated"></div>
    </section>

    <!-- PAGE: ë¶€ë™ì‚° -->
    <section class="page" id="page-realestate" data-page="realestate">
      <div class="page-title">
        <div>
          <div class="page-h2">ğŸ  ë¶€ë™ì‚°</div>
          <div class="page-desc">ë¬´ë£Œ ëª¨ë“œ: ìƒ˜í”Œ ì¹´ë“œë§Œ í‘œì‹œ<br/>ì‹¤ê±°ë˜/KB/apt2.me ìë™í™”ëŠ” ë‹¤ìŒ ë‹¨ê³„(ìŠ¤í¬ë˜í•‘/ì˜¤í”ˆAPI)ë¡œ í™•ì¥</div>
        </div>
      </div>

      <div class="card">
        <div class="section-header">
          <div class="section-title">ë¶€ë™ì‚° ì‹œí™©</div>
          <span style="font-size:11px;color:var(--muted);font-weight:900">ìƒ˜í”Œ</span>
        </div>
        <div class="re-grid" id="reGrid">
          <div class="re-card"><div class="re-region">ì„œìš¸</div><div class="re-value up">+0.02%</div><div class="re-sub neutral-c">ìƒ˜í”Œ</div></div>
          <div class="re-card"><div class="re-region">ê²½ê¸°</div><div class="re-value down">-0.03%</div><div class="re-sub neutral-c">ìƒ˜í”Œ</div></div>
          <div class="re-card"><div class="re-region">ì¸ì²œ</div><div class="re-value neutral-c">-0.01%</div><div class="re-sub neutral-c">ìƒ˜í”Œ</div></div>
          <div class="re-card"><div class="re-region">ë¶€ì‚°</div><div class="re-value up">+0.04%</div><div class="re-sub neutral-c">ìƒ˜í”Œ</div></div>
          <div class="re-card"><div class="re-region">ì „ì„¸</div><div class="re-value up">+0.01%</div><div class="re-sub neutral-c">ìƒ˜í”Œ</div></div>
          <div class="re-card"><div class="re-region">ê±°ë˜ëŸ‰</div><div class="re-value neutral-c" style="font-size:13px">2,341ê±´</div><div class="re-sub neutral-c">ìƒ˜í”Œ</div></div>
        </div>
      </div>
    </section>

    <!-- PAGE: ì£¼ì‹ -->
    <section class="page" id="page-stocks" data-page="stocks">
      <div class="page-title">
        <div>
          <div class="page-h2">ğŸ“ˆ ì£¼ì‹</div>
          <div class="page-desc">ë¬´ë£Œ ëª¨ë“œ: QQQ/SPYë§Œ ì‹¤ì‹œê°„ ëŠë‚Œ (Stooq)<br/>ê°œë³„ ì¢…ëª© ì‹¤ì‹œê°„ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ í™•ì¥ ê°€ëŠ¥</div>
        </div>
      </div>

      <div class="stock-list" id="stockList">
        <div class="stock-item">
          <div class="stock-rank">1</div>
          <div class="stock-icon" style="background:#818cf822;color:#818cf8">QQQ</div>
          <div class="stock-info">
            <div class="stock-name">Invesco QQQ</div>
            <div class="stock-ticker">QQQ.US (Stooq)</div>
          </div>
          <div class="stock-price-wrap">
            <div class="stock-price" id="qqqPrice">â€”</div>
            <div class="stock-change" id="qqqChg">â€”</div>
          </div>
        </div>
        <div class="stock-item">
          <div class="stock-rank">2</div>
          <div class="stock-icon" style="background:#4c8ef722;color:#4c8ef7">SPY</div>
          <div class="stock-info">
            <div class="stock-name">SPDR S&P 500</div>
            <div class="stock-ticker">SPY.US (Stooq)</div>
          </div>
          <div class="stock-price-wrap">
            <div class="stock-price" id="spyPrice">â€”</div>
            <div class="stock-change" id="spyChg">â€”</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-header"><div class="section-title">ë©”ëª¨</div></div>
        <div class="page-desc">
          Â· ë¬´ë£Œë¡œ â€œì•ˆì •ì ì¸ ì¢…ëª© ì‹¤ì‹œê°„â€ì€ í•œê³„ê°€ ìˆìŒ(ê³µì‹ APIëŠ” ëŒ€ë¶€ë¶„ ìœ ë£Œ)<br/>
          Â· ê·¸ë˜ë„ Worker(í”„ë¡ì‹œ+ìºì‹œ) ë¶™ì´ë©´ ë¬´ë£Œ ì†ŒìŠ¤ë„ í›¨ì”¬ ì•ˆì •í™”ë¨
        </div>
      </div>
    </section>

    <!-- PAGE: í™˜ìœ¨ -->
    <section class="page" id="page-fx" data-page="fx">
      <div class="page-title">
        <div>
          <div class="page-h2">ğŸ’± í™˜ìœ¨</div>
          <div class="page-desc">USD/KRW: Stooq ë¬´ë£Œ ë°ì´í„°</div>
        </div>
      </div>

      <div class="card">
        <div class="section-header"><div class="section-title">USD/KRW</div></div>
        <div class="fx-row" id="fxRowClone">
          <div class="fx-card"><div class="fx-label">USD/KRW</div><div class="fx-value" id="usdkrwValue">â€”</div><div class="fx-change" id="usdkrwChg">â€”</div></div>
          <div class="fx-card"><div class="fx-label">ê¸°ì¤€ê¸ˆë¦¬</div><div class="fx-value">â€”</div><div class="fx-change neutral-c">ë¬´ë£Œëª¨ë“œ(ë¯¸êµ¬í˜„)</div></div>
          <div class="fx-card"><div class="fx-label">êµ­ê³ ì±„ 3Y</div><div class="fx-value">â€”</div><div class="fx-change neutral-c">ë¬´ë£Œëª¨ë“œ(ë¯¸êµ¬í˜„)</div></div>
        </div>
      </div>
    </section>

    <!-- PAGE: ì„¤ì • -->
    <section class="page" id="page-settings" data-page="settings">
      <div class="page-title">
        <div>
          <div class="page-h2">âš™ï¸ ì„¤ì •</div>
          <div class="page-desc">ë¬´ë£Œ ëª¨ë“œ êµ¬ì„±<br/>Stooq + ë¬´ë£Œ CORS í”„ë¡ì‹œ + ë¡œì»¬ ìºì‹œ</div>
        </div>
      </div>

      <div class="card">
        <div class="page-h2" style="font-size:13px;margin-bottom:6px">ë°ì´í„° ì†ŒìŠ¤</div>
        <div class="page-desc" id="sourceStatus">
          Â· QQQ / SPY / USDKRW: Stooq<br/>
          Â· CORS í”„ë¡ì‹œ: allorigins / corsproxy / whateverorigin (ìˆœì°¨ ì‹œë„)
        </div>
      </div>

      <div class="card">
        <div class="page-h2" style="font-size:13px;margin-bottom:6px">ìë™ ê°±ì‹ </div>
        <div class="page-desc">
          Â· 10ë¶„ë§ˆë‹¤ ìë™ ê°±ì‹  (ë¬´ë£Œ í”„ë¡ì‹œ ë¶€ë‹´ ë‚®ê²Œ)<br/>
          Â· ì‹¤íŒ¨ ì‹œ ë§ˆì§€ë§‰ ì„±ê³µê°’(localStorage) í‘œì‹œ
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <nav class="bottom-nav">
    <div class="nav-item active" data-target="market"><div class="nav-icon">ğŸ“Š</div><div class="nav-label">ì‹œí™©</div></div>
    <div class="nav-item" data-target="realestate"><div class="nav-icon">ğŸ </div><div class="nav-label">ë¶€ë™ì‚°</div></div>
    <div class="nav-item" data-target="stocks"><div class="nav-icon">ğŸ“ˆ</div><div class="nav-label">ì£¼ì‹</div></div>
    <div class="nav-item" data-target="fx"><div class="nav-icon">ğŸ’±</div><div class="nav-label">í™˜ìœ¨</div></div>
    <div class="nav-item" data-target="settings"><div class="nav-icon">âš™ï¸</div><div class="nav-label">ì„¤ì •</div></div>
  </nav>

  <script>
    // -------------------------
    // UI: ë‚ ì§œ / íƒ­ ì „í™˜
    // -------------------------
    const now = new Date();
    const DAYS = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    document.getElementById('todayDate').textContent =
      `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ (${DAYS[now.getDay()]})`;

    const pages = Array.from(document.querySelectorAll('.page'));
    const navItems = Array.from(document.querySelectorAll('.nav-item'));
    function setActiveTab(target) {
      navItems.forEach(n => n.classList.toggle('active', n.dataset.target === target));
      pages.forEach(p => p.classList.toggle('active', p.dataset.page === target));
      window.scrollTo({ top: 0, behavior: 'instant' });
    }
    navItems.forEach(n => n.addEventListener('click', () => setActiveTab(n.dataset.target)));

    function showToast(msg, duration = 3000) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), duration);
    }

    // -------------------------
    // ë¬´ë£Œ ë°ì´í„°: Stooq + ë¬´ë£Œ CORS í”„ë¡ì‹œ
    // -------------------------
    // Stooq CSV: https://stooq.com/q/l/?s=qqq.us&i=d
    // ì»¬ëŸ¼: Symbol,Date,Time,Open,High,Low,Close,Volume
    const STOOQ = {
      qqq: "https://stooq.com/q/l/?s=qqq.us&i=d",
      spy: "https://stooq.com/q/l/?s=spy.us&i=d",
      usdkrw: "https://stooq.com/q/l/?s=usdkrw&i=d"
    };

    const CORS_PROXIES = [
      // 1) allorigins
      (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
      // 2) corsproxy.io
      (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
      // 3) whateverorigin
      (u) => `https://www.whateverorigin.org/get?url=${encodeURIComponent(u)}&callback=?`
    ];

    async function fetchTextWithProxy(url) {
      let lastErr = null;

      for (const proxy of CORS_PROXIES) {
        try {
          const proxied = proxy(url);
          const res = await fetch(proxied, { cache: "no-store" });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          // whateveroriginì€ JSONP/JSON í˜•íƒœë¡œ ì˜¬ ìˆ˜ ìˆì–´ ì²˜ë¦¬
          const ct = res.headers.get("content-type") || "";
          if (proxied.includes("whateverorigin.org")) {
            const txt = await res.text();
            // whateveroriginì€ ë³´í†µ {"contents":"...csv..."} í˜•íƒœ JSONì„ ë‚´ë ¤ì¤Œ
            try {
              const json = JSON.parse(txt);
              if (json && json.contents) return String(json.contents);
            } catch {
              // JSON parse ì‹¤íŒ¨ë©´ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ ë°˜í™˜(ìµœí›„)
              return txt;
            }
          }

          return await res.text();
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error("ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨");
    }

    function parseStooqCSV(csv) {
      // ì²« ì¤„: í—¤ë”, ë‘˜ì§¸ ì¤„: ê°’
      const lines = String(csv).trim().split("\n");
      if (lines.length < 2) throw new Error("CSV í¬ë§· ì´ìƒ");
      const header = lines[0].split(",");
      const row = lines[1].split(",");

      const idx = (name) => header.indexOf(name);
      const close = Number(row[idx("Close")]);
      const open = Number(row[idx("Open")]);
      const symbol = row[idx("Symbol")];
      const date = row[idx("Date")];
      const time = row[idx("Time")] || "";

      return { symbol, date, time, open, close, change: close - open, pct: open ? ((close-open)/open)*100 : 0 };
    }

    // -------------------------
    // ë¯¸ë‹ˆ ì°¨íŠ¸(ëœë¤: ë¬´ë£Œ ëª¨ë“œ ì‹œê°ìš©)
    // -------------------------
    function miniChart(points, isUp) {
      const color = isUp ? '#ff5b5b' : '#4c8ef7';
      const gradId = 'g' + Math.random().toString(36).substr(2,5);
      const min = Math.min(...points), max = Math.max(...points);
      const range = max - min || 1;
      const w = 100, h = 30;
      const pts = points.map((v, i) => {
        const x = (i / (points.length - 1)) * w;
        const y = h - ((v - min) / range) * (h - 4) - 2;
        return `${x},${y}`;
      }).join(' ');
      return `<svg class="mini-chart" viewBox="0 0 100 30" preserveAspectRatio="none">
        <defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${color}" stop-opacity="0.2"/>
          <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
        </linearGradient></defs>
        <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="${pts} 100,30 0,30" fill="url(#${gradId})" stroke="none"/>
      </svg>`;
    }
    function randomPoints(base, volatility, count = 14, trend = 0) {
      const pts = [base];
      for (let i = 1; i < count; i++) {
        const prev = pts[i-1];
        const change = (Math.random() - 0.48) * volatility + trend;
        pts.push(Math.max(prev + change, base * 0.9));
      }
      return pts;
    }

    // -------------------------
    // ë Œë”
    // -------------------------
    function renderIndexCard(name, valueText, changeText, up) {
      const pts = randomPoints(100, up ? 1.8 : 2.2, 14, up ? 0.2 : -0.2);
      const arrow = up ? "â–²" : "â–¼";
      const cls = up ? "up" : "down";
      return `<div class="index-card">
        <div class="index-name">${name}</div>
        <div class="index-value">${valueText}</div>
        <div class="index-change ${cls}">${arrow} ${changeText}</div>
        ${miniChart(pts, up)}
      </div>`;
    }

    function renderFXRow(usdkrw, delta, up) {
      return `
        <div class="fx-card">
          <div class="fx-label">USD/KRW</div>
          <div class="fx-value">${usdkrw}</div>
          <div class="fx-change ${up ? 'down' : 'up'}">${delta}</div>
        </div>
        <div class="fx-card"><div class="fx-label">ê¸°ì¤€ê¸ˆë¦¬</div><div class="fx-value">â€”</div><div class="fx-change neutral-c">ë¬´ë£Œëª¨ë“œ</div></div>
        <div class="fx-card"><div class="fx-label">êµ­ê³ ì±„ 3Y</div><div class="fx-value">â€”</div><div class="fx-change neutral-c">ë¬´ë£Œëª¨ë“œ</div></div>
      `;
    }

    function setLastUpdated(text) {
      document.getElementById("lastUpdated").textContent = text;
    }

    // -------------------------
    // ìºì‹œ(ë§ˆì§€ë§‰ ì„±ê³µê°’): ê³„ì† ì‹¤íŒ¨í•´ë„ í™”ë©´ì€ ìœ ì§€
    // -------------------------
    const LS_KEY = "apt1ab_free_cache_v1";
    function saveCache(obj) {
      try { localStorage.setItem(LS_KEY, JSON.stringify(obj)); } catch {}
    }
    function loadCache() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    // -------------------------
    // ë©”ì¸ ë¡œë“œ
    // -------------------------
    async function loadMarketData() {
      const icon = document.getElementById('refreshIcon');
      icon.classList.add('spin');

      try {
        // ë³‘ë ¬ë¡œ 3ê°œ ìš”ì²­(ë¬´ë£Œ í”„ë¡ì‹œë¼ ê³¼ë¶€í•˜ ë°©ì§€í•˜ë ¤ë©´ 2ê°œë§Œ í•´ë„ ë˜ëŠ”ë°, ì—¬ê¸°ì„  í•œ ë²ˆë§Œ ì‹¤í–‰)
        const [qqqTxt, spyTxt, fxTxt] = await Promise.all([
          fetchTextWithProxy(STOOQ.qqq),
          fetchTextWithProxy(STOOQ.spy),
          fetchTextWithProxy(STOOQ.usdkrw),
        ]);

        const qqq = parseStooqCSV(qqqTxt);
        const spy = parseStooqCSV(spyTxt);
        const fx = parseStooqCSV(fxTxt);

        // QQQ/SPY: ê°’ í‘œì‹œ
        const qqqUp = qqq.change >= 0;
        const spyUp = spy.change >= 0;

        const fmtUSD = (n) => `$${n.toFixed(2)}`;
        const fmtChg = (c, p) => `${c >= 0 ? '+' : ''}${c.toFixed(2)} (${p >= 0 ? '+' : ''}${p.toFixed(2)}%)`;

        document.getElementById("usIndexRow").innerHTML =
          renderIndexCard("ë‚˜ìŠ¤ë‹¥ ëŒ€ì²´(QQQ)", fmtUSD(qqq.close), fmtChg(qqq.change, qqq.pct), qqqUp) +
          renderIndexCard("S&P500 ëŒ€ì²´(SPY)", fmtUSD(spy.close), fmtChg(spy.change, spy.pct), spyUp);

        // ì£¼ì‹ íƒ­ë„ ë°˜ì˜
        document.getElementById("qqqPrice").textContent = fmtUSD(qqq.close);
        document.getElementById("qqqChg").textContent = fmtChg(qqq.change, qqq.pct);
        document.getElementById("qqqChg").className = `stock-change ${qqqUp ? 'up' : 'down'}`;

        document.getElementById("spyPrice").textContent = fmtUSD(spy.close);
        document.getElementById("spyChg").textContent = fmtChg(spy.change, spy.pct);
        document.getElementById("spyChg").className = `stock-change ${spyUp ? 'up' : 'down'}`;

        // í™˜ìœ¨(usdkrw): StooqëŠ” Closeê°€ í™˜ìœ¨ê°’
        const fxValue = Math.round(fx.close).toLocaleString();
        const fxDelta = `${fx.change >= 0 ? '+' : ''}${fx.change.toFixed(1)} (${fx.pct >= 0 ? '+' : ''}${fx.pct.toFixed(2)}%)`;
        const fxUp = fx.change >= 0;

        document.getElementById("fxRow").innerHTML = renderFXRow(fxValue, fxDelta, fxUp);
        document.getElementById("usdkrwValue").textContent = fxValue;
        document.getElementById("usdkrwChg").textContent = fxDelta;
        document.getElementById("usdkrwChg").className = `fx-change ${fxUp ? 'up' : 'down'}`;

        // í™˜ìœ¨ íƒ­ cloneë„ ë°˜ì˜
        const clone = document.getElementById("fxRowClone");
        if (clone) clone.innerHTML = renderFXRow(fxValue, fxDelta, fxUp);

        // ìš”ì•½
        document.getElementById("summaryText").innerHTML =
          `ë¬´ë£Œ ëª¨ë“œë¡œ <strong>QQQ(SPY)</strong>ì™€ <strong>USD/KRW</strong>ë¥¼ ê°€ì ¸ì™”ì–´ìš”.<br/>
           <strong>QQQ</strong> ${qqqUp ? 'ìƒìŠ¹' : 'í•˜ë½'} (${(qqq.pct>=0?'+':'')}${qqq.pct.toFixed(2)}%), 
           <strong>SPY</strong> ${spyUp ? 'ìƒìŠ¹' : 'í•˜ë½'} (${(spy.pct>=0?'+':'')}${spy.pct.toFixed(2)}%).<br/>
           í™˜ìœ¨ì€ <strong>${fxValue}ì›</strong> (${fxDelta}).`;

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸
        const t = new Date();
        setLastUpdated(`ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')}:${String(t.getSeconds()).padStart(2,'0')}`);

        // ìºì‹œ ì €ì¥
        saveCache({
          qqq, spy, fx,
          updatedAt: t.toISOString()
        });

      } catch (e) {
        console.error(e);
        // ìºì‹œê°€ ìˆìœ¼ë©´ ìºì‹œë¼ë„ ë¿Œë¦¼
        const cached = loadCache();
        if (cached?.qqq && cached?.spy && cached?.fx) {
          const qqq = cached.qqq, spy = cached.spy, fx = cached.fx;

          const qqqUp = qqq.change >= 0;
          const spyUp = spy.change >= 0;

          const fmtUSD = (n) => `$${Number(n).toFixed(2)}`;
          const fmtChg = (c, p) => `${Number(c) >= 0 ? '+' : ''}${Number(c).toFixed(2)} (${Number(p) >= 0 ? '+' : ''}${Number(p).toFixed(2)}%)`;

          document.getElementById("usIndexRow").innerHTML =
            renderIndexCard("ë‚˜ìŠ¤ë‹¥ ëŒ€ì²´(QQQ)", fmtUSD(Number(qqq.close)), fmtChg(qqq.change, qqq.pct), qqqUp) +
            renderIndexCard("S&P500 ëŒ€ì²´(SPY)", fmtUSD(Number(spy.close)), fmtChg(spy.change, spy.pct), spyUp);

          const fxValue = Math.round(Number(fx.close)).toLocaleString();
          const fxDelta = `${Number(fx.change) >= 0 ? '+' : ''}${Number(fx.change).toFixed(1)} (${Number(fx.pct) >= 0 ? '+' : ''}${Number(fx.pct).toFixed(2)}%)`;
          const fxUp = Number(fx.change) >= 0;

          document.getElementById("fxRow").innerHTML = renderFXRow(fxValue, fxDelta, fxUp);
          const clone = document.getElementById("fxRowClone");
          if (clone) clone.innerHTML = renderFXRow(fxValue, fxDelta, fxUp);

          document.getElementById("summaryText").innerHTML =
            `âš ï¸ ë¬´ë£Œ í”„ë¡ì‹œ í˜¸ì¶œì´ ì‹¤íŒ¨í•´ì„œ <strong>ë§ˆì§€ë§‰ ì €ì¥ê°’</strong>ìœ¼ë¡œ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤.<br/>
             ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`;

          setLastUpdated(`(ìºì‹œ í‘œì‹œ) ë§ˆì§€ë§‰ ì„±ê³µ ì—…ë°ì´íŠ¸: ${cached.updatedAt || 'â€”'}`);
          showToast("âš ï¸ ë¬´ë£Œ í”„ë¡ì‹œ ì‹¤íŒ¨ â†’ ìºì‹œë¡œ í‘œì‹œ", 3500);
        } else {
          showToast("âŒ ë¬´ë£Œ í”„ë¡ì‹œ/ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ì ì‹œ í›„ ë‹¤ì‹œ", 3500);
          document.getElementById("summaryText").innerHTML =
            `âŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”. (ë¬´ë£Œ í”„ë¡ì‹œ/ë„¤íŠ¸ì›Œí¬ ì´ìŠˆ)<br/>
             ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`;
        }
      } finally {
        icon.classList.remove('spin');
      }
    }

    // ì´ˆê¸° ë¡œë“œ
    loadMarketData();
    // ë¬´ë£Œ í”„ë¡ì‹œ ë¶€ë‹´ ì¤„ì´ê¸°: 10ë¶„ë§ˆë‹¤
    setInterval(() => loadMarketData(), 10 * 60 * 1000);
  </script>
</body>
</html>
